@ vim: set ft=armv4 noet:

	.arch armv4t
	.cpu  arm7tdmi

#include <dawn/util/asminc.h>
#include <dawn/hw/addrspace.h>
#include <dawn/hw/irq/regs.h>

	.extern main
	.extern __stack_sys
	.extern __bss_start
	.extern __bss_end

	@ don't know what mode we're executing at, so let's try something
	.arm
DAWN_BEGIN_FUNC _start, .text.startup._start
	@ disable IRQs
	mov r0, #IO_BASE
	str r0, [r0, #(REG_IME_ADDR-IO_BASE)]

	@ reset stack pointer
	ldr sp, =__stack_sys

	@ clear bss
	mov r0, #0
	ldr r1, =__bss_start
	ldr r2, =__bss_end
	@ both are aligned to 4 bytes so we can use 32-bit writes here
1:	cmp r1, r2
	beq 2f
3:	str r0, [r1], #4
	cmp r1, r2
	bne 3b
2:

	ldr r0, =main
	adr lr, 1f
	bx  r0

1:	b 1b

	.pool
DAWN_END_FUNC _start

