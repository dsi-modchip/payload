
#include <stddef.h>
#include <stdint.h>
#include <stdbool.h>

#include <dawn/hw/memory.h>

#include <dawn/baremetal-rt/abi/twl_loram.h>
#include <dawn/baremetal-rt/abi/twl_hiram.h>
#include <dawn/baremetal-rt/abi/sysv.h>
#include <dawn/baremetal-rt/abi/hb_transferregion.h>


__attribute__((__always_inline__))
inline static void bios_memcpy(const void* src, volatile void* dst, size_t len) {
	void (*bios_memcpy_fptr)(const void*, volatile void*, size_t) = 0xffff0808;
	bios_memcpy_fptr(src, dst, len);
}


void itcm_wait_by_loop(int32_t x);
__attribute__((__no_inline__, __naked__, __target__("arm")))
void itcm_wait_by_loop(int32_t x) {
	asm volatile(
	"1:	\n"
		"subs r0, r0, #4\n"
		"bcs 1b\n"
		"bx lr\n"
	:::"r0"
	);
}


void fcram_magic_init_sequence(uintptr_t addr);
__attribute__((__no_inline__, __naked__, __target__("arm")))
void fcram_magic_init_sequence(uintptr_t addr) {
	asm volatile(
		"ldr  r1, =0xffff\n"
		"ldr  r2, =0xffde\n"
		"ldrh r3, [r0, #0]\n"
		"strh r3, [r0, #0]\n"
		"strh r3, [r0, #0]\n"
		"nop\n"
		"ldr  r3, =0xffea\n"
		"strh r1, [r0, #0]\n"
		"strh r2, [r0, #0]\n"
		"strh r3, [r0, #0]\n"
		"bx lr\n"
		".pool\n"
	:::"r1","r2","r3"
	);
}
static void fcram_init(uint32_t thing) {
	itcm_wait_by_loop(0x10000);
	if (REG_EXMEMCNT & REG_EXMEMCNT_CE2_Msk) return;

	REG_EXMEMCNT = REG_EXMEMCNT_CE2_Msk;
	itcm_wait_by_loop(0x10000);

	if (thing != 0) {
		fcram_magic_init_sequence(0x02fffffe);
		fcram_magic_init_sequence(0x0dfffffe);
	}

	REG_EXMEMCNT = 0xec8c; // TODO: use macros for this magic constant
	itcm_wait_by_loop(0x2000);

	fcram_magic_init_sequence(0x02fffffe);
	fcram_magic_init_sequence(0x0dfffffe);
}

__attribute__((__used__, __externally_visible__, __noreturn__))
int main(void) {
	static const uint8_t magic[16] = {
		0xf0,0x9f,0x8f,0xb3,0xef,0xb8,0x8f,0xe2,
		0x80,0x8d,0xe2,0x9a,0xa7,0xef,0xb8,0x8f
	};

	void (*boot9i_LZ77_close)(void) = 0xffff9558;
	//void (*boot9i_panic_show_err)(uint32_t errcode) = 0xffff9828|1;
	void (*ipc_notifyrecv)(uint32_t id) = 0xffff4c30|1;
	void (*ipc_notifyID)(int id) = 0xffff4ba4|1;

	boot9i_LZ77_close();

	// wait for ARM7 hack to complete
	//boot9i_panic_show_err(0xa7);
	ipc_notifyrecv(42);
	// :eyes:
	//boot9i_panic_show_err(0x4acced);

	fcram_init(0x1f);

	bios_memcpy((const void*)0xffff0000, (void*)0x02000000, 65536);
	bios_memcpy(magic, (void*)0x02020000, sizeof(magic));

	ipc_notifyID(43);

	//boot9i_panic_show_err(0x777);

	// TODO: draw the rest of the fucking owl

	while(1);
	__builtin_unreachable();
}

